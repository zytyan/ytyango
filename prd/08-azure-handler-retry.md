# **Azure 图像处理重试与限流重构 PRD**

## **产品名称：Azure 图像处理退避重试优化**

## **版本：v0.1**

## **撰写日期：2025-12-14**

---

## **1. 背景（Background）**

当前 `myhandlers/azure.go` 针对 OCR 与内容审核的调用仅依赖固定 3s 间隔的 `rate.Limiter`，缺少重试与退避。实际运行中偶发网络抖动或服务端 429/5xx 时直接报错，用户需要重复发送图片。RPM 与最小间隔等参数散落在代码中、难以调整，导致维护成本高。

---

## **2. 目标（Objectives）**

- 为 OCR 与 Moderator 调用引入带随机抖动的指数退避，最多重试 3 次，失败时保持现有返回值行为。
- 将限流与重试参数集中配置，支持快速调整 RPM 与最小间隔，减少重复代码。
- 保持缓存、返回数据结构与外部接口不变，降低业务侧改动成本。

---

## **3. 非目标（Out of Scope）**

- 不更换 Azure SDK 或新增外部依赖。
- 不修改缓存大小、消息文案或上层路由逻辑。
- 不新增持久化或监控上报功能。

---

## **4. 用户角色（User Personas）**

### **终端用户（群聊/私聊用户）**

- 希望图片识别在短时间内成功，不需要重复发送。

### **运维/开发维护者**

- 希望快速调节调用频率与重试策略，避免代码大改；关注异常时的可预期行为。

---

## **5. 用户故事（User Stories）**

1. 作为用户，我发送图片时，即使 Azure 偶发超时，机器人也能在合理时间内自动重试并返回结果。
2. 作为维护者，我可以通过修改集中配置快速调整 RPM 或最小间隔以应对限流。
3. 作为维护者，我希望重试失败时仍返回与现在一致的错误，避免上层逻辑回归。

---

## **6. 功能需求（Functional Requirements）**

| ID   | 描述                                                               | 优先级 |
| ---- | ---------------------------------------------------------------- | ---- |
| FR-1 | OCR、Moderator 调用增加带抖动的指数退避重试，最多 3 次             | 高   |
| FR-2 | 重试失败时保持现有错误返回，不改变函数签名与返回数据               | 高   |
| FR-3 | RPM 与最小间隔等限流/重试参数集中配置，代码路径简化、便于调整       | 高   |
| FR-4 | 保留现有缓存策略与 RateLimited 处理逻辑，保证行为一致              | 中   |

---

## **7. 非功能需求（Non-functional Requirements）**

### **可靠性（Reliability）**

- 在 Azure 返回可重试错误时自动补偿，减少用户侧失败重试。
- 退避等待时间控制在可接受范围内（单次最长不超过约 5s 级别）。

### **可维护性（Maintainability）**

- 限流与重试相关常量集中定义，代码分支减少，便于后续调整。
- 新增逻辑需符合当前格式化/测试规范（`gofmt`、`go test ./...`）。

---

## **8. 技术方案（Tech Design Summary）**

- 抽象限流参数：以 RPM 和最小间隔计算 `rate.Limiter`，集中定义常量便于修改。
- 实现通用退避函数：基于指数回退（如 500ms 起步，倍增）叠加随机抖动，最多尝试 3 次；失败返回最后一次错误，保持接口不变。
- 在 OCR 与 Moderator 流程中调用通用退避函数，复用缓存与大小校验逻辑，减少重复代码。

---

## **9. 里程碑（Milestones）**

| 时间  | 目标                                   |
| ----- | ------------------------------------ |
| Day 1 | 完成限流配置集中化与重试退避实现方案评审 |
| Day 2 | 落地代码重构与自测（含 gofmt、go test） |
| Day 3 | 根据反馈调整与合并，准备上线             |

