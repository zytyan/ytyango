# **Telegram 文件下载磁盘缓存 PRD**

## **产品名称：DownloadToDisk 缓存增强**

## **版本：v0.1**

## **撰写日期：2025-12-14**

---

## **1. 背景（Background）**

现有 `DownloadToDisk` 仅下载到临时文件且不复用，同一文件会多次拉取；淘汰时也不会清理磁盘，易累积垃圾。需要引入缓存与并发合并，提升复用并避免磁盘膨胀。

---

## **2. 目标（Objectives）**

- 为 `DownloadToDisk` 增加基于文件 ID 的缓存与 `singleflight`，同一文件使用稳定的文件名/路径。
- 当缓存淘汰时自动删除对应磁盘文件，避免残留。
- 保持现有返回值与调用方式不变，减少业务侧改动。

---

## **3. 非目标（Out of Scope）**

- 不改动内存下载逻辑（`DownloadToMemoryCached`）。
- 不新增持久化元数据或引入外部存储。
- 不调整缓存容量（除非必要的小幅调整）。

---

## **4. 用户故事（User Stories）**

1. 作为维护者，我希望同一文件 ID 只下载一次并复用同一磁盘路径，避免重复 IO。
2. 作为维护者，我希望缓存淘汰时自动删除临时文件，磁盘不会持续膨胀。
3. 作为调用方，我不需要改代码即可享受缓存效果。

---

## **5. 功能需求（Functional Requirements）**

| ID   | 描述                                                                 | 优先级 |
| ---- | ------------------------------------------------------------------ | ---- |
| FR-1 | `DownloadToDisk` 增加 LRU 缓存，命中直接返回已有文件路径             | 高   |
| FR-2 | 缓存淘汰时删除对应文件，避免磁盘残留                                 | 高   |
| FR-3 | 同一文件 ID 使用稳定文件名/路径（可基于 ID）                         | 高   |
| FR-4 | 并发下载使用 `singleflight` 合并请求                                 | 中   |

---

## **6. 技术方案（Tech Design Summary）**

- 基于文件 ID 构造稳定文件路径（例如 `${tmpdir}/bot_file_${fileId}`），下载成功后写入。
- LRU 缓存存储文件路径；设置 `OnEvicted` 回调删除文件。
- `singleflight.Group` 合并并发下载请求，失败不写入缓存。
- 保持函数签名不变，调用方透明。

---

## **7. 里程碑（Milestones）**

| 时间  | 目标                               |
| ----- | -------------------------------- |
| Day 1 | 完成方案与实现，写入缓存与淘汰清理 |
| Day 2 | 自测与代码评审，`go test ./...`   |
| Day 3 | 根据反馈微调与上线                 |
