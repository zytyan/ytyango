# **Product Requirements Document**

## **产品名称：SQLite → PostgreSQL 迁移（pgx/v5）**

## **版本：v1.0**

## **撰写日期：2025-12-23**

---

## **1. 背景（Background）**

- 现有数据库使用 SQLite（`mattn/go-sqlite3` + WAL），主库与 `saved_msgs` 分离，均通过 `sqlc` 的 SQLite 方言生成代码（`?` 占位符、`INT_BOOL/INT_UNIX_SEC/JSON_TEXT/BLOB_*` 自定义类型、`WITHOUT ROWID`、生成列与触发器）。
- 初始化与缓存逻辑（`globalcfg`）基于 `database/sql` 的 sqlite3 驱动，测试依赖内存 SQLite；部分业务逻辑直接处理 sqlite 唯一约束错误（如 `saved_pics`）。
- 随着并发与多实例需求增加，SQLite 的文件锁、单机存储与备份运维成本已成为瓶颈，难以复用云端能力（备份、监控、TLS）、也无法统一连接池与错误码生态。
- 需要迁移到 PostgreSQL，并使用 `pgx/v5` 作为标准驱动/连接池，同时保持现有业务行为与数据完整性，提供平滑的数据迁移方案。

---

## **2. 目标（Objectives）**

- 将主库与消息存档库切换到 PostgreSQL，全部 SQL 生成与运行时均基于 `pgx/v5`。
- 为现有 SQLite schema 提供等价的 PostgreSQL DDL（类型映射、生成列、触发器/函数、索引）并通过 `sqlc` 重新生成查询代码。
- 提供一套可重复的数据迁移工具（SQLite → PostgreSQL），支持主库与可选 `saved_msgs`，并给出校验/回滚路径。
- 维持业务功能与性能：缓存、前缀和、评分、Gemini 会话、Bilibili/ytdl 缓存等行为不变；上线前后可通过测试与校验确认。

---

## **3. 非目标（Out of Scope）**

- 不引入新的业务特性（仅迁移存储层）；不改动 MeiliSearch/HTTP 接口行为。
- 不交付数据库集群自动化（备份/监控/高可用部署视为运维侧任务，本文不覆盖）。
- 不改动非数据库依赖（Azure、YTDLP 等）与消息格式。

---

## **4. 用户角色（User Personas）**

### **运维/部署者**
- 负责提供 PostgreSQL 实例、证书/网络配置，期望有健康检查与慢查询日志。

### **后端开发者**
- 需要最小化代码改动成本（保留 `sqlc` 生成的调用方式），并获取清晰的类型/错误码映射。

### **数据/合规使用者**
- 需要迁移后数据一致、可审计，评分/消息等统计不丢失。

---

## **5. 用户故事（User Stories）**

1. 作为运维，我希望用连接串配置主库/消息库，启动时即可完成 `SELECT 1` 健康检查与连接池初始化。
2. 作为开发者，我希望复用 `sqlc` 生成的查询，只需切换为 PostgreSQL 占位符/类型和 `pgx/v5` 驱动即可通过编译与测试。
3. 作为维护者，我需要一键迁移 SQLite 数据到 PostgreSQL，并能输出行数校验、冲突/跳过记录。
4. 作为测试/CI 使用者，我希望有可重复的测试数据库准备方案（本地 Docker/CI PG），替代内存 SQLite。

---

## **6. 功能需求（Functional Requirements）**

### **6.1 连接与配置**

| ID | 描述 | 优先级 |
| --- | --- | --- |
| FR-1 | 支持 PostgreSQL 连接串配置主库与消息库（`DATABASE_URL` / `MSG_DATABASE_URL`），未配置消息库时回退使用主库。 | 高 |
| FR-2 | 使用 `pgx/v5` 连接池（建议 pgxpool 或 stdlib + 自建池），提供最大连接数/闲置/超时配置，启动时进行 `SELECT 1` 健康检查。 | 高 |
| FR-3 | 保留慢查询阈值与 zap 日志输出，记录连接错误、超时与重连行为，不再依赖 SQLite PRAGMA。 | 中 |
| FR-4 | 支持 TLS/密码等安全参数的透传，不在日志中泄漏连接串敏感信息。 | 中 |

### **6.2 Schema 与 SQL 迁移**

| ID | 描述 | 优先级 |
| --- | --- | --- |
| FR-5 | 为现有所有表提供 PostgreSQL DDL：将 `INT_BOOL` → `boolean`，`INT_UNIX_SEC` → `timestamptz`（入库时从 Unix 秒转换），`JSON_TEXT` → `jsonb`，`BLOB/BLOB_*` → `bytea`，自增字段用 `bigserial`/`generated by default as identity`。 | 高 |
| FR-6 | 迁移 `saved_pics` 生成列与触发器：`user_rate` 生成列、评分计数触发器、`UNIQUE(user_rate, rand_key)`、`pic_rate_counter` 同步逻辑在 PostgreSQL 下可用（plpgsql）。 | 高 |
| FR-7 | 迁移其余触发器/约束（如 `saved_msgs` 的 `edit_history`、`gemini_contents` 外键与 CHECK），确保等价行为。 | 高 |
| FR-8 | 所有查询文件改为 PostgreSQL 占位符 `$1...`，兼容方言差异（`LIMIT/OFFSET`、UPSERT、`RETURNING`），并更新 `sqlc.yaml` 为 `engine: postgresql` + `pgx/v5` 代码生成与类型 overrides。 | 高 |
| FR-9 | 保留/完善索引策略（例如 `chat_cfg.web_id`、`chat_stat_daily` 主键、`saved_msgs` 索引），评估必要的复合索引以匹配原有查询性能。 | 中 |

### **6.3 数据迁移**

| ID | 描述 | 优先级 |
| --- | --- | --- |
| FR-10 | 提供 SQLite → PostgreSQL 迁移工具（Go/Python 均可），支持主库与可选 `saved_msgs`，可指定源路径与目标连接串，遇到主键冲突可选择跳过/覆盖。 | 高 |
| FR-11 | 迁移工具输出行数/校验报告（每表计数、跳过记录、错误日志），支持小批量/流式导入，避免一次性加载大表。 | 中 |
| FR-12 | 提供迁移演练/回滚指南：可在新库上校验通过后切换，遇到问题可恢复到 SQLite 或重新导入。 | 中 |

### **6.4 应用层改造**

| ID | 描述 | 优先级 |
| --- | --- | --- |
| FR-13 | 替换 sqlite3 驱动为 `pgx/v5`（池或 stdlib），`globalcfg` 初始化与 `Q/Msgs` 准备逻辑适配新驱动与上下文超时。 | 高 |
| FR-14 | 更新错误处理：将 `sqlite3.ErrConstraint*` 重写为 `pgconn.PgError`（唯一冲突等），保持重试/降级语义（如插入 `saved_pics` 时的 RandKey 冲突）。 | 高 |
| FR-15 | 重写测试初始化：使用 PostgreSQL 测试实例（Docker/本地/CI 环境变量），提供 schema 初始化脚本，移除对内存 SQLite 的硬依赖。 | 高 |
| FR-16 | 更新脚本与文档：`sqlc` 重新生成、`go mod tidy`、`gofmt`，以及 README/配置示例指向 PostgreSQL。 | 中 |

### **6.5 可观测性与运维**

| ID | 描述 | 优先级 |
| --- | --- | --- |
| FR-17 | 启动与定时自检（如 `SELECT 1`、连接池统计），可输出到日志/metrics，用于报警与排查。 | 中 |
| FR-18 | 评估长连接/大事务影响，提供超时/重试策略（例如 `BuildCountByRatePrefixSum` 背景任务的超时）。 | 低 |

---

## **7. 非功能需求（Non-functional Requirements）**

- **性能**：常规查询 p95 保持 ≤50ms；连接池上限可配置，确保在多实例下不触发连接耗尽。
- **可靠性**：迁移前后行数/约束一致；主键/外键/生成列行为与原有 SQLite 等价；应用启动前完成健康检查。
- **安全**：连接串敏感信息不写日志；支持 TLS/认证参数；迁移脚本避免将数据落地到临时文件（如需则加密/清理）。
- **可维护性**：`go test ./...` 在 PostgreSQL 环境通过（如外部依赖导致失败需注明）；所有 DDL/迁移脚本文档化，可重复执行。

---

## **8. 技术方案（Tech Design Summary）**

- 连接：优先 `pgx/v5` 的 `pgxpool`；若保持 `database/sql` 接口，可使用 `pgx/v5/stdlib` 注册驱动并自定义池参数，慢查询记录继续由 `Queries.logger` 负责。
- DDL：为自定义类型提供映射/Domain（可选 `CREATE DOMAIN int_unix_sec AS bigint` 等），所有表用 PostgreSQL 语法重写；触发器用 `plpgsql` 函数实现评分计数与编辑历史。
- `sqlc`：`engine: postgresql`，指定 `sql_package: "pgx/v5"`（取决于 wasm 插件支持），调整 overrides 映射到新类型，SQL 占位符改为 `$n`。
- 迁移：提供 CLI/脚本读取 SQLite（行流式），按表批量插入 PostgreSQL，附加校验（计数、采样 checksum），可跳过 `saved_msgs` 或拆分批次。
- 测试：提供本地/CI 使用的 `POSTGRES_URL_TEST`，启动时执行 schema，替换 `initForTests` 逻辑；保留缓存/前缀和等行为的单测/集成测试。

---

## **9. 数据结构（Data Models）**

### **users（示例）**

```sql
CREATE TABLE users (
    id               bigserial PRIMARY KEY,
    updated_at       timestamptz NOT NULL,
    user_id          bigint     NOT NULL UNIQUE,
    first_name       text       NOT NULL,
    last_name        text,
    profile_update_at timestamptz NOT NULL,
    profile_photo    text,
    timezone         integer    NOT NULL DEFAULT 480 CHECK (timezone BETWEEN -86400 AND 86400)
);
```

### **saved_pics / pic_rate_counter**

```sql
CREATE TABLE saved_pics (
    file_uid        text    PRIMARY KEY,
    file_id         text    NOT NULL,
    bot_rate        integer NOT NULL,
    rand_key        bigint  NOT NULL,
    user_rating_sum integer NOT NULL DEFAULT 0,
    rate_user_count integer NOT NULL DEFAULT 0,
    user_rate       integer GENERATED ALWAYS AS (
        CASE WHEN rate_user_count > 0
             THEN ROUND(user_rating_sum::numeric / rate_user_count)::int
             ELSE bot_rate END
    ) STORED,
    UNIQUE (user_rate, rand_key),
    UNIQUE (rand_key)
);

CREATE TABLE pic_rate_counter (
    rate  integer PRIMARY KEY,
    count bigint   NOT NULL
);
-- 触发器：插入/更新/删除 saved_pics_rating 时同步计数，行为等价于现有 SQLite 触发器。
```

### **saved_msgs / edit_history**

```sql
CREATE TABLE saved_msgs (
    chat_id             bigint      NOT NULL,
    message_id          bigint      NOT NULL,
    from_user_id        bigint,
    sender_chat_id      bigint,
    date                timestamptz NOT NULL,
    forward_origin_name text,
    forward_origin_id   bigint,
    message_thread_id   bigint,
    reply_to_message_id bigint,
    reply_to_chat_id    bigint,
    via_bot_id          bigint,
    edit_date           timestamptz,
    media_group_id      text,
    text                text,
    entities_json       jsonb,
    media_id            text,
    media_uid           text,
    media_type          text,
    extra_data          jsonb,
    extra_type          text,
    PRIMARY KEY (chat_id, message_id)
);

CREATE TABLE edit_history (
    chat_id    bigint NOT NULL,
    message_id bigint NOT NULL,
    edit_id    bigint NOT NULL,
    text       text   NOT NULL,
    PRIMARY KEY (chat_id, message_id, edit_id)
);
```

---

## **10. 里程碑（Milestones）**

| 时间 | 目标 |
| --- | --- |
| Day 1 | 确认 DDL 映射与 `sqlc`/pgx 方案，PRD 评审通过。 |
| Day 3 | 完成 PostgreSQL DDL、`sqlc` 配置与代码编译通过，核心查询与触发器落地。 |
| Day 5 | 迁移工具开发与自测（含 `saved_msgs` 可选导入），`go test ./...` 通过（在 PostgreSQL 环境）。 |
| Day 6 | 预演迁移与回滚流程，准备上线文档/配置样例，完成代码合并。 |

---

## **11. 风险（Risks）与对策（Mitigations）**

| 风险 | 影响 | 对策 |
| --- | --- | --- |
| 类型/方言不兼容导致生成列、触发器或约束行为变化 | 业务数据错误或查询失败 | 提前列出映射表，使用 PostgreSQL 专用 DDL 与单测覆盖关键表（saved_pics/saved_msgs/chat_stat 等）。 |
| 迁移数据量大或表锁导致停机窗口过长 | 影响上线/回滚 | 采用分批迁移与校验，提供跳过大表选项，迁移前压测；保留回滚方案（切换回 SQLite 或重建 PG 库）。 |
| 测试环境依赖 PostgreSQL，CI/开发机不可用 | 阻塞交付 | 提供 Docker/脚本一键拉起测试库，CI 配置独立连接串；必要时在本地跳过集成测试并注明。 |
| 错误码处理遗漏（如唯一约束重试） | 运行时失败或行为变化 | 统一封装 `pgconn.PgError` 映射，补充重试/降级逻辑的单测。 |

---

## **12. 验收标准（Acceptance Criteria）**

- 代码中不再依赖 `github.com/mattn/go-sqlite3`，数据库初始化与查询均通过 `pgx/v5`；`sqlc` 生成代码基于 PostgreSQL，占位符与类型均更新。
- PostgreSQL DDL 落地并通过基础集成测试，`go test ./...` 在配置的 PostgreSQL 实例上可执行（外部依赖失败需说明）。
- 迁移工具可将现有 SQLite 数据导入 PostgreSQL，输出行数校验报告，核心表（users/chat_cfg/chat_stat/saved_pics/gemini/saved_msgs）数据一致或有明确差异说明。
- 启动/运行日志显示健康检查与慢查询统计正常，核心功能（评分、Gemini 会话、YTDL 缓存、消息存档）在 PostgreSQL 下工作正常。 
