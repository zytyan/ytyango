# **MathParser 性能优化 PRD**

## **产品名称：MathParser 性能优化**

## **版本：v0.1**

## **撰写日期：2025-12-14**

---

## **1. 背景（Background）**

MathParser 作为机器人基础算式解析器，承载 `/solve` 与自动计算能力。近期在群聊高并发或长算式场景下出现：

- 简单表达式也出现肉眼可见的回复延迟，CPU 占用偏高。
- 解析路径缺少基准测试与基线数据，优化方向缺乏量化目标。
- `FastCheck` 与 Eval 共用较重的正则/大对象，短输入仍产生多次分配。

需要为 MathParser 补齐性能基线、压缩延迟与分配，保证作为基础组件的可扩展性。

---

## **2. 目标（Objectives）**

- 建立覆盖常见算式类别的基准测试（含 FastCheck、简单算术、幂/阶乘/排列组合），输出当前基线。
- 在既有功能等价前提下，将基线 `ns/op` 及分配次数至少降低 **30%**（以优化前同机型、同 Go 版本的基准为参照）。
- 简短表达式（长度 ≤ 20 的整数/小数算式）单次 Eval 平均耗时 **≤ 100µs/op**，分配 **≤ 4 次**（以 `go test -bench` 为准）。
- 保持错误类型与返回值行为不变，新增测试覆盖典型非法输入与大数边界。
- 提供性能回归检查指引（Bench 命令、对比步骤）并落地到仓库文档。

---

## **3. 非目标（Out of Scope）**

- 不新增运算符/语法特性（仅聚焦性能与健壮性）。
- 不引入外部 C 扩展或替换为其他数值类型（继续使用 `big.Rat`）。
- 不改动上层处理器的用户交互与文案。

---

## **4. 用户角色（User Personas）**

### **终端用户（群聊用户）**

- 希望即时得到算式结果，无感知解析延迟。

### **机器人维护者**

- 关注 CPU 占用、内存分配，期待可重复的性能验证步骤。
- 需要兼容现有错误返回，避免行为回归。

---

## **5. 用户故事（User Stories）**

1. 作为群聊用户，我在发送「1+2*3-4/5」时希望机器人几乎即时回复（<1s）。
2. 作为维护者，我希望有基准测试能在本地/CI 快速得到性能数据，并能与历史版本对比。
3. 作为维护者，我希望性能优化不改变错误提示类型，避免上层逻辑异常。

---

## **6. 功能需求（Functional Requirements）**

| ID   | 描述                                                                 | 优先级 |
| ---- | -------------------------------------------------------------------- | ---- |
| FR-1 | 新增基准测试覆盖：FastCheck、简单整数/小数算式、含阶乘/排列组合/幂的算式 | 高   |
| FR-2 | 记录优化前基准（ns/op、B/op）并在文档中说明运行环境与命令             | 高   |
| FR-3 | 优化词法/语法/求值流程，确保相同输入输出等价且基准降耗 ≥30%          | 高   |
| FR-4 | 扩充单元测试，覆盖非法字符、非整数阶乘/取模、溢出边界等场景          | 中   |
| FR-5 | 输出性能回归检查流程（如 benchstat 对比步骤、推荐命令）               | 中   |

---

## **7. 非功能需求（Non-functional Requirements）**

### **性能（Performance）**

- 简短算式 Eval：平均 ≤100µs/op、分配 ≤4（以基准测试输出为准）。
- FastCheck：平均 ≤400ns/op，零错误率。
- 并发 4 goroutine 下，10k 次 Eval 总耗时较现状缩短 ≥30%。

### **稳定性（Reliability）**

- 所有现有/新增测试通过；错误类型与信息结构保持兼容。
- 对超大数值仍返回既有错误类型（不 panic）。

### **可维护性（Maintainability）**

- 基准与回归指引写入仓库文档，便于后续开发者复现。
- 代码路径添加必要注释，说明关键优化点与约束。

---

## **8. 技术方案（Tech Design Summary）**

- **基准体系**：在 `helpers/mathparser` 增加 `Benchmark` 套件，涵盖代表性表达式；可选提供 `benchstat` 脚本用于对比。
- **词法优化方向**：减少 rune/字符串重复分配（例如基于切片重用、手工扫描替代正则）；简化数字解析分支。
- **语法/求值优化方向**：收紧栈分配（预分配容量、复用临时对象）；对整数路径使用 `big.Int` 快速通道避免浮点往返；保持幂/阶乘边界检查。
- **回归保障**：补齐非法输入、大数边界的单测；确保返回的 `CalcError` 类型稳定。

---

## **9. 数据结构（Data Models）**

- 无新增持久化结构；仍以现有 `Token`、`CalcError` 等结构为核心，仅允许内部字段优化（如缓存/预分配）且不改变外部接口。

---

## **10. 里程碑（Milestones）**

| 时间       | 目标                               |
| ---------- | -------------------------------- |
| Day 1      | 补齐基准测试与现状基线数据，文档化基准命令 |
| Day 2–3    | 词法/语法/求值路径优化，保证功能等价    |
| Day 4      | 回归测试与 bench 对比，输出优化效果     |

---

## **11. 基准记录（2025-12-14）**

- 环境：`go1.25.5 linux/amd64`，CPU `12th Gen Intel(R) Core(TM) i3-12300T`
- 命令：`go test -bench=. -benchmem ./helpers/mathparser`

| Benchmark                     | Before ns/op | Before B/op | Before allocs | After ns/op | After B/op | After allocs |
| ----------------------------- | ------------ | ----------- | ------------- | ----------- | ---------- | ------------ |
| BenchmarkFastCheck-8          | 292.1        | 0           | 0             | 32.11       | 0          | 0            |
| BenchmarkEvaluateSimple-8     | 5211         | 4666        | 122           | 2020        | 761        | 33           |
| BenchmarkEvaluatePowFloat-8   | 4919         | 3089        | 81            | 3269        | 1234       | 40           |
| BenchmarkEvaluateFactorial-8  | 3802         | 3129        | 77            | 1745        | 472        | 22           |
| BenchmarkEvaluatePermutation-8| 1548         | 1112        | 39            | 693.4       | 320        | 13           |
| BenchmarkEvaluateParallelSimple-8 | 3076     | 4668        | 122           | 856.4       | 763        | 33           |

- 现状：短算式延迟相比基线下降约 61%，allocs/op 下降约 73%；FastCheck 进入 0 分配水平。

---

## **12. 性能回归检查指引**

- 日常校验：`go test -bench=. -benchmem ./helpers/mathparser`
- 版本对比：`go test -bench=. -benchmem ./helpers/mathparser > /tmp/bench-new.txt` 后使用 `benchstat /tmp/bench-old.txt /tmp/bench-new.txt` 对比。
- 关注指标：`BenchmarkEvaluateSimple` allocs/op 保持在 35 以内、ns/op 稳定在 2–3µs 区间；FastCheck 保持 0 分配。
