# **Product Requirements Document**

## **产品名称：GenAI Handler 抽离与 Gemini JavaScript 执行**

## **版本：v1.0**

## **撰写日期：2025-12-19**

---

## **1. 背景（Background）**

`handlers/gemini_ai.go` 目前集成了会话缓存、数据库持久化、Telegram 交互、genai 客户端与工具调用等多种职责，代码耦合度高、扩展成本大。
近期为 Gemini 增补了 `//execjs` 协议和 goja Runtime 雏形，但尚未形成可复用的封装，也缺少资源隔离与错误兜底。
需要将通用的生成式 AI 能力抽离为独立的 `genai_hldr`，并在该模块内落地 JavaScript 执行链路，降低后续功能演进的心智负担与风险。

---

## **2. 目标（Objectives）**

* 抽离 Gemini 聊天逻辑至独立的 `genai_hldr` 包，明确会话管理、消息归档、提示词构建、模型调用的边界。
* 保持现有 Telegram 侧体验（命中范围、表情反馈、Markdown 渲染、数据库写入等）不回归。
* 实现可控的 JavaScript 执行能力：模型输出 `//execjs+ … //execjs-` 包裹的脚本可在受限环境运行，输出通过 `reply()` 注入下一轮对话。
* 提供可观测、可测试的接口，便于后续扩展（新增工具、模型或渠道）。

---

## **3. 非目标（Out of Scope）**

* 不更改现有数据库 schema（沿用 `gemini_session`、`gemini_content` 等现有表结构）。
* 不新增对外暴露的机器人指令或 UI；聊天触发规则保持不变。
* 不在本迭代引入新的模型供应商或推理后端。

---

## **4. 用户角色（User Personas）**

### **维护者 / 开发者**

* 需要易读的模块边界，便于调试与迭代。
* 希望在出问题时快速定位日志/指标，隔离 JS 执行带来的风险。

### **Gemini 功能使用者（Telegram 群成员）**

* 继续获得稳定的回复体验，能在需要时请求简单的 JS 运算或格式化。
* 出现错误时收到明确提示，而不是无响应。

---

## **5. 用户故事（User Stories）**

1. 作为维护者，我希望有独立的 `genai_hldr` 包来管理会话与模型调用，不用在主 handler 内穿插细节。
2. 作为群用户，我希望在模型回复中加入 `//execjs` 段落即可执行简单脚本，得到计算结果的回复。
3. 作为维护者，我希望 JS 执行出现异常或超时时能记录日志并向用户返回错误文案，不影响主流程。
4. 作为维护者，我希望能为 `genai_hldr` 添加单测，覆盖会话缓存、提示词拼装和 JS 执行语义。

---

## **6. 功能需求（Functional Requirements）**

| ID | 描述 | 优先级 |
| --- | --- | --- |
| FR-1 | 创建独立的 `genai_hldr` 模块/包，封装会话缓存、数据库读写、genai client 初始化、系统提示词构建等职责，对外暴露简洁接口供 Telegram handler 调用。 | 高 |
| FR-2 | 保持现有触发条件、会话复用与反应表情行为；迁移后用户体验与数据落库语义与现状一致。 | 高 |
| FR-3 | 解析模型回复中的 `//execjs+` 与 `//execjs-` 标记，提取脚本并在 goja Runtime 中执行，支持 ECMAScript 5.1。 | 高 |
| FR-4 | 在 JS 环境中提供 `reply(obj)` 函数，输出内容会作为新的对话消息附加到 session，并在下一轮 prompt 中带上（不直接回显给用户）。 | 高 |
| FR-5 | 为 JS 执行设置资源限制（单次执行超时、最大输出/内存占用、禁用标准库危险接口），执行错误需捕获并回传用户，同时写入日志。 | 高 |
| FR-6 | 执行链路需可观测：记录脚本片段、耗时、异常；必要时打点/日志区分正常输出与错误输出。 | 中 |
| FR-7 | 为 `genai_hldr` 增补单元/集成测试，覆盖会话命中、内容转换、`//execjs` 解析与输出写入逻辑。 | 中 |
| FR-8 | 系统提示词通过可配置的模板生成（包含时间、群名称、bot 名称等占位符），模板易于维护与复用，支持后续新增工具或渠道时按需扩展。 | 中 |
| FR-9 | 系统提示词模板通过 `go:embed` 内置，运行时无需外部文件依赖。 | 中 |
| FR-10 | `//execjs` 脚本的源码与执行结果不直接回显给用户；向模型追加“执行成功/失败 + 简介”标记，由模型在 `//execjs+` 后输出简述。 | 中 |
| FR-11 | 提供聊天消息搜索能力：支持在存量会话消息中按关键词/用户名查询，返回结果需包含 user_id 与用户名，模型可通过调用工具获取最近匹配结果，并在回复中引用。 | 中 |

---

## **7. 非功能需求（Non-functional Requirements）**

* **可靠性**：JS 执行超时或抛错不影响主聊天流程，模型回复仍可返回（带错误提示）；会话缓存并发安全。
* **安全**：goja 运行环境禁用网络/文件等危险接口，限制输出长度与执行时间，防止 DoS。
* **可维护性**：`genai_hldr` 接口文档化，内聚度高；代码符合 `gofmt`，依赖更新后执行 `go mod tidy`。
* **可观测性**：关键路径有结构化日志，错误包含 session/chat 上下文，便于追踪。

---

## **8. 技术方案概述（Tech Design Summary）**

* 新建 `genai_hldr` 包（位置：`myhandlers/genai_hldr` 或同级子目录），内部包含：
  * 会话管理（缓存、失效、数据库加载与持久化）。
  * 提示词与 Tool 配置生成：系统提示词通过 `go:embed` 嵌入的模板渲染（预置占位符：当前时间、chat 名称/类型、bot 名称与 username、工具说明），模板可多语言扩展且无需外部文件。
  * 模型调用适配器，包装 `genai.Client` 与重试/超时。
  * JS 执行子模块：封装 goja Runtime 复用、`reply()` 注入、脚本截取、输出累积；限制单次执行超时与内存占用（如通过 goja 限制/上下文 cancel/对象池控制），执行结果仅形成“执行成功/失败 + 简介”标记附加回会话，不直接回显源码或详细输出。
  * 消息搜索工具：封装聊天记录查询（按关键词/用户名，限制返回条数），结果携带 user_id 与用户名，供模型通过工具调用获取最近匹配消息摘要。
* Telegram 侧 `GeminiReply` 仅负责消息路由与交互（表情、SendChatAction），核心逻辑委托给 `genai_hldr`。
* JS 执行：识别 `//execjs+` 与 `//execjs-` 之间的内容，多段脚本顺序执行，结果作为新的 text 消息（带标记类型）写入 session。

---

## **9. 里程碑（Milestones）**

| 时间 | 目标 |
| --- | --- |
| Day 1 | PRD 评审通过，完成 `genai_hldr` 目录与接口设计草图。 |
| Day 2 | 完成架构迁移（会话管理、提示词构建、模型调用抽离），保持现有行为。 |
| Day 3 | 完成 JS 执行链路（解析、执行、回写、错误处理）并自测。 |
| Day 4 | 补充测试用例，跑通 `go test ./...`，准备合并。 |

---

## **10. 风险（Risks）与对策（Mitigations）**

| 风险 | 影响 | 对策 |
| --- | --- | --- |
| JS 执行可能阻塞或泄漏资源 | 聊天延迟、进程负载上升 | 设置严格的超时与输出上限，执行结束释放 runtime 资源；必要时加并发限流。 |
| 迁移后行为不一致（持久化、提示词） | 用户体验回归或数据缺失 | 对照现有行为编写回归测试；上线前灰度观察日志。 |
| goja 安全面覆盖不足 | 潜在注入或崩溃 | 仅暴露 `reply`，禁用外部接口；对异常统一捕获并返回。 |

---

## **11. 验收标准（Acceptance Criteria）**

* Telegram 侧触发、表情反馈、Markdown 渲染与现有版本一致。
* `genai_hldr` 对外接口清晰，核心逻辑不再散落在通用 handler 中。
* 模型输出的 `//execjs` 段可被正确解析并执行，执行结果以“成功/失败 + 简介”写回上下文（不回显源码/完整输出），`reply()` 结果体现在后续 prompt；错误/超时有明确提示并被日志记录。
* 消息搜索工具可按关键词/用户名返回受限条数的最新匹配消息摘要，结果包含 user_id 与用户名，并可被模型用于生成回复。
* `go test ./...` 通过；若因外部依赖导致失败需在说明中记录。
