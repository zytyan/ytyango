# **产品需求文档**

## **产品名称：Replacer 模板替换测试与修复**

## **版本：v1.0**

## **撰写日期：2026-01-09**


## **1. 背景（Background）**

helpers/replacer 是一个模板替换工具，基于 handlers/gemini_ai.go 里的模板替换需求扩展。
当前缺少测试覆盖，且实现细节需要对照实际业务使用方式进行 review，避免在模板解析、变量替换与错误处理上产生隐性问题。

---

## **2. 目标（Objectives）**

* 覆盖模板解析、变量替换、未知变量与边界输入的核心路径。
* 对照 handlers/gemini_ai.go 的使用方式，修复替换逻辑中的潜在问题。
* 确保新增测试在本地可重复运行。

---

## **3. 非目标（Out of Scope）**

* 不新增新的模板变量类型。
* 不改动 handlers/gemini_ai.go 的业务逻辑。
* 不引入新的第三方依赖。

---

## **4. 用户角色（User Personas）**

### **维护者**

* 依赖稳定的替换结果来构建 Gemini prompt。
* 需要测试用例快速定位解析错误。

---

## **5. 用户故事（User Stories）**

1. **作为维护者，我希望模板中所有合法变量都能被正确替换。**
2. **作为维护者，我希望未知变量与非法格式保持原样，便于发现错误。**
3. **作为维护者，我希望测试能覆盖多个边界输入（空字符串、转义、未闭合）。**

---

## **6. 功能需求（Functional Requirements）**

| ID   | 描述                                               | 优先级 |
| ---- | -------------------------------------------------- | ------ |
| FR-1 | 覆盖普通文本、变量替换、%% 转义的替换逻辑           | 高     |
| FR-2 | 覆盖非法变量名、未知变量、未闭合 % 的输出规则       | 高     |
| FR-3 | 覆盖时间相关变量的可控输出（使用固定时间）          | 中     |
| FR-4 | 对照 gemini_ai.go 使用方式验证 chat/bot 相关变量    | 中     |

---

## **7. 非功能需求（Non-functional Requirements）**

* 测试必须可重复运行，不依赖外部服务。
* 测试可在 CI 环境中稳定执行。

---

## **8. 技术方案（Tech Design Summary）**

* 基于 Go 标准 testing 包新增单元测试。
* 构造 gotgbot.Message / Chat / Bot 的最小可用实例，避免额外依赖。
* 使用固定时间点构造 ReplaceCtx，确保 TIME/DATE/DATETIME 可预测。

---

## **9. 里程碑（Milestones）**

| 时间 | 目标                     |
| ---- | ------------------------ |
| Day 1 | PRD 与待办清单完成        |
| Day 2 | Replacer 代码 review 与修复 |
| Day 3 | 测试用例完成并通过        |

---

## **10. 风险（Risks）与对策（Mitigations）**

| 风险                               | 影响     | 对策                         |
| ---------------------------------- | -------- | ---------------------------- |
| gotgbot 结构体初始化复杂            | 测试编写困难 | 仅构造必要字段，避免真实 API 调用 |
| 解析边界遗漏导致回归               | 行为变化  | 以 gemini_ai.go 使用方式为准建立断言 |

---

## **11. 验收标准（Acceptance Criteria）**

* 新增 replacer 测试用例，覆盖核心路径与边界输入。
* 若发现逻辑问题，修复并新增测试验证。
* `go test ./...` 通过（若外部依赖导致失败需注明）。

