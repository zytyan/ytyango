# **Product Requirements Document**

## **产品名称：测试环境内存数据库初始化修复**

## **版本：v1.0**

## **撰写日期：2025-12-13**

---

## **1. 背景（Background）**

- go test 下 `globalcfg.init()` 设置 `DatabasePath=:memory:` 后立即调用生产初始化，重新加载配置并跳过内存 schema 导入。
- 测试可能打开生产数据库或空路径，导致缺表、污染真实数据或 CI 不稳定。

---

## **2. 目标（Objectives）**

- 确保 `go test` 始终使用纯内存 SQLite，并从 `sql/schema_*.sql` 加载完整表结构。
- 避免测试阶段读取/依赖生产配置文件或磁盘路径。
- 保持生产初始化逻辑与配置兼容性不变。

---

## **3. 非目标（Out of Scope）**

- 更改生产配置格式、文件位置或启动方式。
- 重写 schema/migration 机制。
- 引入新的测试框架或外部依赖。

---

## **4. 用户角色（User Personas）**

### **开发者 / CI 维护者**

- 需要在本地或 CI 运行 `go test`，不触碰生产数据库。
- 希望初始化失败时能快速定位（明确 panic/日志）。

---

## **5. 用户故事（User Stories）**

1. 作为开发者，运行 `go test ./...` 时自动创建内存库并导入 schema，无需手工准备 DB 文件。
2. 作为维护者，当配置文件缺失或路径无效时，测试依然在内存库上运行且不会覆盖磁盘文件。
3. 作为开发者，我能安全地在本地/CI 并行运行测试，互不干扰。

---

## **6. 功能需求（Functional Requirements）**

| ID | 描述 | 优先级 |
| --- | --- | --- |
| FR-1 | 测试初始化过程中禁止调用生产配置加载，直接使用内置的测试 Config（`DatabasePath=:memory:`）。 | 高 |
| FR-2 | 测试初始化必须加载 `sql/schema_*.sql` 创建表/触发器，确保 Q/Msgs 预编译成功。 | 高 |
| FR-3 | 测试初始化不应访问或创建任何磁盘数据库文件（含 `msgDb`）。 | 高 |
| FR-4 | 若内存库初始化失败（schema 读写错误），需显式 panic/log，方便排障。 | 中 |

---

## **7. 非功能需求（Non-functional Requirements）**

- 可靠性：测试间互不影响，重复运行不会留下文件。
- 可维护性：初始化逻辑清晰分层，避免重复加载/双写。
- 兼容性：生产路径/日志级别默认行为保持不变。

---

## **8. 技术方案（Tech Design Summary）**

- 为测试路径提供独立的 init 流程：跳过 `initConfig()`，直接构建 Config 并初始化 logger/DB。
- 初始化主 DB（及 Msgs 相关对象）使用同一内存连接，调用 `initMainDatabaseInMemory` 按 schema 文件建表。
- 确认 build tags / `testing.Testing()` 判断顺序，避免 `initByConfig` 抢先完成并阻断测试初始化。

---

## **9. 里程碑（Milestones）**

| 时间 | 目标 |
| --- | --- |
| Day 1 | PRD 定稿；明确测试初始化流程与责任函数。 |
| Day 2 | 完成实现与本地 `go test ./...` 自测，提交代码。 |

---

## **10. 风险（Risks）与对策（Mitigations）**

| 风险 | 影响 | 对策 |
| --- | --- | --- |
| 生产初始化与测试初始化交错执行导致重复/冲突 | 测试仍打开磁盘 DB | 严格隔离 init 流程，检查 `Q`/`Msgs` 判空与调用顺序。 |
| schema 文件新增/改名未被测试加载 | 测试缺表 | 采用统一 glob 规则并在缺表时 panic，定期更新。 |
| 未来新增 Msg DB 或多库初始化 | 代码耦合/遗漏 | 将测试初始化抽象成可复用函数，集中管理连接/准备逻辑。 |

---

## **11. 验收标准（Acceptance Criteria）**

- 在无配置文件的环境下执行 `go test ./...`，日志显示使用内存 DB 且不会创建磁盘文件。
- 测试运行前 schema 表与触发器已建立，Q/Msgs 准备成功，无缺表或找不到文件错误。
- 生产启动路径与日志级别未受影响。
